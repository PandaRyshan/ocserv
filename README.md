# ocserv + certbot 2 in 1 image

---

## Description

This repo combines [ocserv](https://ocserv.gitlab.io/www/recipes.html) VPN server and [certbot](https://eff-certbot.readthedocs.io/en/stable/using.html#) in one image, allowing users to use secure VPN service and request or renew cert automatically.  The certbot-dns-cloudflare plugin is installed by default.

This image provided a default config in `/etc/ocserv/ocserv.conf`. If you don't mount a conf file, it will generate a new one. And [ENV file](https://github.com/PandaRyshan/ocserv/blob/main/.env) is used to request a Letsencrypt certificate and create a default username. If no ENV is provided, the ocserv service will be started with a locally generated certificate.

The latest version is 1.2.2, and dockerhub page is [here](https://hub.docker.com/r/duckduckio/ocserv).

---

Usage:

Server:

  * clone this repo
  * check the environment config in `docker-compose.yml`. email address is optional and only for certs expiration remind if certs renew failed
  * (optional) mount your local dir to keep your certificates and config files
    * if you want get certs via cloudflare api token, please mount config file into config/ folder
    * if you want to get certs via http, please make sure 80 port is open
  * run `docker-compose up -d`
  * keep in mind add `listen-proxy-proto = true` in your `ocserv.conf` if you want to put ocserv in the back of proxy, like haproxy. 
  * if you don't provide a default user/pass, there's a new user/pass will be generated by default, and you could check it at `$HOME/initial_pass.txt` or `docker compose logs ocserv`
  * added WAIT_* options in compose file, and ocserv will be run after items you provided are ready, see usage: [link](https://github.com/ufoscout/docker-compose-wait/tree/2.12.0)
  
Client:

You could use a Cisco Anyconnect client or Cisco secure client to connect the server, or use openconnect client by following steps.

  * prepare connect and disconnect scripts and save them to somewhere in your user space:

    **anyconnect.sh**

    ```shell
    #!/bin/bash

    sudo openconnect -b -q --protocol=anyconnect <your-domain> << delimiter
    <your-username>
    <your-password>
    delimiter
    ```

    **kill-anyconnect.sh**

    ```shell
    #!/bin/bash

    sudo pkill openconnect
    ```

  * create a soft link of script as a system command:

    ```shell
    sudo ln -s <your-srcipt.sh> /usr/local/bin/<command-you-want>
    ```

See more usage: `openconnect --help`

---

References:
  - [Recipes for Openconnect VPN - Official](https://ocserv.gitlab.io/www/recipes.html)
  - [Openconnect VPN Manual - Official](https://ocserv.gitlab.io/www/manual.html)
  - [Ocserv Advanced](https://www.linuxbabe.com/linux-server/ocserv-openconnect-vpn-advanced)
  - [Block Visitors by Country Using Firewall](https://www.ip2location.com/free/visitor-blocker)

---

Known issues:

* [ ] cannot connect with Cisco secure client on macOS

